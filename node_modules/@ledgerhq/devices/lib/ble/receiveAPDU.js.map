{"version":3,"sources":["../../src/ble/receiveAPDU.js"],"names":["TagId","receiveAPDU","rawStream","Observable","create","o","notifiedIndex","notifiedDataLength","notifiedData","Buffer","alloc","sub","subscribe","complete","error","DisconnectedDevice","unsubscribe","e","String","next","value","tag","readUInt8","index","readUInt16BE","data","slice","TransportError","toString","concat","length"],"mappings":";;;;;;;AAEA;;AACA;;AACA;;AAEA,MAAMA,KAAK,GAAG,IAAd,C,CAEA;;AACO,MAAMC,WAAW,GACtBC,SADyB,IAGzBC,iBAAWC,MAAX,CAAmBC,CAAD,IAAO;AACvB,MAAIC,aAAa,GAAG,CAApB;AACA,MAAIC,kBAAkB,GAAG,CAAzB;AACA,MAAIC,YAAY,GAAGC,MAAM,CAACC,KAAP,CAAa,CAAb,CAAnB;AAEA,QAAMC,GAAG,GAAGT,SAAS,CAACU,SAAV,CAAoB;AAC9BC,IAAAA,QAAQ,EAAE,MAAM;AACdR,MAAAA,CAAC,CAACS,KAAF,CAAQ,IAAIC,0BAAJ,EAAR;AACAJ,MAAAA,GAAG,CAACK,WAAJ;AACD,KAJ6B;AAK9BF,IAAAA,KAAK,EAAGG,CAAD,IAAO;AACZ,qBAAI,WAAJ,EAAiB,oBAAoBC,MAAM,CAACD,CAAD,CAA3C;AACAZ,MAAAA,CAAC,CAACS,KAAF,CAAQG,CAAR;AACAN,MAAAA,GAAG,CAACK,WAAJ;AACD,KAT6B;AAU9BG,IAAAA,IAAI,EAAGC,KAAD,IAAW;AACf,YAAMC,GAAG,GAAGD,KAAK,CAACE,SAAN,CAAgB,CAAhB,CAAZ;AACA,YAAMC,KAAK,GAAGH,KAAK,CAACI,YAAN,CAAmB,CAAnB,CAAd;AACA,UAAIC,IAAI,GAAGL,KAAK,CAACM,KAAN,CAAY,CAAZ,CAAX;;AAEA,UAAIL,GAAG,KAAKrB,KAAZ,EAAmB;AACjBK,QAAAA,CAAC,CAACS,KAAF,CACE,IAAIa,sBAAJ,CAAmB,iBAAiBN,GAAG,CAACO,QAAJ,CAAa,EAAb,CAApC,EAAsD,YAAtD,CADF;AAGA;AACD;;AAED,UAAItB,aAAa,KAAKiB,KAAtB,EAA6B;AAC3BlB,QAAAA,CAAC,CAACS,KAAF,CACE,IAAIa,sBAAJ,CACE,gEACEJ,KADF,GAEE,gBAFF,GAGEjB,aAJJ,EAKE,iBALF,CADF;AASA;AACD;;AAED,UAAIiB,KAAK,KAAK,CAAd,EAAiB;AACfhB,QAAAA,kBAAkB,GAAGkB,IAAI,CAACD,YAAL,CAAkB,CAAlB,CAArB;AACAC,QAAAA,IAAI,GAAGA,IAAI,CAACC,KAAL,CAAW,CAAX,CAAP;AACD;;AACDpB,MAAAA,aAAa;AACbE,MAAAA,YAAY,GAAGC,MAAM,CAACoB,MAAP,CAAc,CAACrB,YAAD,EAAeiB,IAAf,CAAd,CAAf;;AACA,UAAIjB,YAAY,CAACsB,MAAb,GAAsBvB,kBAA1B,EAA8C;AAC5CF,QAAAA,CAAC,CAACS,KAAF,CACE,IAAIa,sBAAJ,CACE,+DACEnB,YAAY,CAACsB,MADf,GAEE,gBAFF,GAGEvB,kBAJJ,EAKE,gBALF,CADF;AASA;AACD;;AACD,UAAIC,YAAY,CAACsB,MAAb,KAAwBvB,kBAA5B,EAAgD;AAC9CF,QAAAA,CAAC,CAACc,IAAF,CAAOX,YAAP;AACAH,QAAAA,CAAC,CAACQ,QAAF;AACAF,QAAAA,GAAG,CAACK,WAAJ;AACD;AACF;AA1D6B,GAApB,CAAZ;AA6DA,SAAO,MAAM;AACXL,IAAAA,GAAG,CAACK,WAAJ;AACD,GAFD;AAGD,CArED,CAHK","sourcesContent":["// @flow\n\nimport { TransportError, DisconnectedDevice } from \"@ledgerhq/errors\";\nimport { Observable } from \"rxjs\";\nimport { log } from \"@ledgerhq/logs\";\n\nconst TagId = 0x05;\n\n// operator that transform the input raw stream into one apdu response and finishes\nexport const receiveAPDU = (\n  rawStream: Observable<Buffer>\n): Observable<Buffer> =>\n  Observable.create((o) => {\n    let notifiedIndex = 0;\n    let notifiedDataLength = 0;\n    let notifiedData = Buffer.alloc(0);\n\n    const sub = rawStream.subscribe({\n      complete: () => {\n        o.error(new DisconnectedDevice());\n        sub.unsubscribe();\n      },\n      error: (e) => {\n        log(\"ble-error\", \"in receiveAPDU \" + String(e));\n        o.error(e);\n        sub.unsubscribe();\n      },\n      next: (value) => {\n        const tag = value.readUInt8(0);\n        const index = value.readUInt16BE(1);\n        let data = value.slice(3);\n\n        if (tag !== TagId) {\n          o.error(\n            new TransportError(\"Invalid tag \" + tag.toString(16), \"InvalidTag\")\n          );\n          return;\n        }\n\n        if (notifiedIndex !== index) {\n          o.error(\n            new TransportError(\n              \"BLE: Invalid sequence number. discontinued chunk. Received \" +\n                index +\n                \" but expected \" +\n                notifiedIndex,\n              \"InvalidSequence\"\n            )\n          );\n          return;\n        }\n\n        if (index === 0) {\n          notifiedDataLength = data.readUInt16BE(0);\n          data = data.slice(2);\n        }\n        notifiedIndex++;\n        notifiedData = Buffer.concat([notifiedData, data]);\n        if (notifiedData.length > notifiedDataLength) {\n          o.error(\n            new TransportError(\n              \"BLE: received too much data. discontinued chunk. Received \" +\n                notifiedData.length +\n                \" but expected \" +\n                notifiedDataLength,\n              \"BLETooMuchData\"\n            )\n          );\n          return;\n        }\n        if (notifiedData.length === notifiedDataLength) {\n          o.next(notifiedData);\n          o.complete();\n          sub.unsubscribe();\n        }\n      },\n    });\n\n    return () => {\n      sub.unsubscribe();\n    };\n  });\n"],"file":"receiveAPDU.js"}