"use strict";
/**
 * @packageDocumentation
 * @module Common-AssetAmount
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.StandardAssetAmountDestination = exports.AssetAmount = void 0;
const buffer_1 = require("buffer/");
const bn_js_1 = __importDefault(require("bn.js"));
const errors_1 = require("../utils/errors");
/**
 * Class for managing asset amounts in the UTXOSet fee calcuation
 */
class AssetAmount {
    constructor(assetID, amount, burn) {
        // assetID that is amount is managing.
        this.assetID = buffer_1.Buffer.alloc(32);
        // amount of this asset that should be sent.
        this.amount = new bn_js_1.default(0);
        // burn is the amount of this asset that should be burned.
        this.burn = new bn_js_1.default(0);
        // spent is the total amount of this asset that has been consumed.
        this.spent = new bn_js_1.default(0);
        // stakeableLockSpent is the amount of this asset that has been consumed that
        // was locked.
        this.stakeableLockSpent = new bn_js_1.default(0);
        // change is the excess amount of this asset that was consumed over the amount
        // requested to be consumed(amount + burn).
        this.change = new bn_js_1.default(0);
        // stakeableLockChange is a flag to mark if the input that generated the
        // change was locked.
        this.stakeableLockChange = false;
        // finished is a convenience flag to track "spent >= amount + burn"
        this.finished = false;
        this.getAssetID = () => {
            return this.assetID;
        };
        this.getAssetIDString = () => {
            return this.assetID.toString("hex");
        };
        this.getAmount = () => {
            return this.amount;
        };
        this.getSpent = () => {
            return this.spent;
        };
        this.getBurn = () => {
            return this.burn;
        };
        this.getChange = () => {
            return this.change;
        };
        this.getStakeableLockSpent = () => {
            return this.stakeableLockSpent;
        };
        this.getStakeableLockChange = () => {
            return this.stakeableLockChange;
        };
        this.isFinished = () => {
            return this.finished;
        };
        // spendAmount should only be called if this asset is still awaiting more
        // funds to consume.
        this.spendAmount = (amt, stakeableLocked = false) => {
            if (this.finished) {
                /* istanbul ignore next */
                throw new errors_1.InsufficientFundsError("Error - AssetAmount.spendAmount: attempted to spend " + "excess funds");
            }
            this.spent = this.spent.add(amt);
            if (stakeableLocked) {
                this.stakeableLockSpent = this.stakeableLockSpent.add(amt);
            }
            const total = this.amount.add(this.burn);
            if (this.spent.gte(total)) {
                this.change = this.spent.sub(total);
                if (stakeableLocked) {
                    this.stakeableLockChange = true;
                }
                this.finished = true;
            }
            return this.finished;
        };
        this.assetID = assetID;
        this.amount = typeof amount === "undefined" ? new bn_js_1.default(0) : amount;
        this.burn = typeof burn === "undefined" ? new bn_js_1.default(0) : burn;
        this.spent = new bn_js_1.default(0);
        this.stakeableLockSpent = new bn_js_1.default(0);
        this.stakeableLockChange = false;
    }
}
exports.AssetAmount = AssetAmount;
class StandardAssetAmountDestination {
    constructor(destinations, senders, changeAddresses) {
        this.amounts = [];
        this.destinations = [];
        this.senders = [];
        this.changeAddresses = [];
        this.amountkey = {};
        this.inputs = [];
        this.outputs = [];
        this.change = [];
        // TODO: should this function allow for repeated calls with the same
        //       assetID?
        this.addAssetAmount = (assetID, amount, burn) => {
            let aa = new AssetAmount(assetID, amount, burn);
            this.amounts.push(aa);
            this.amountkey[aa.getAssetIDString()] = aa;
        };
        this.addInput = (input) => {
            this.inputs.push(input);
        };
        this.addOutput = (output) => {
            this.outputs.push(output);
        };
        this.addChange = (output) => {
            this.change.push(output);
        };
        this.getAmounts = () => {
            return this.amounts;
        };
        this.getDestinations = () => {
            return this.destinations;
        };
        this.getSenders = () => {
            return this.senders;
        };
        this.getChangeAddresses = () => {
            return this.changeAddresses;
        };
        this.getAssetAmount = (assetHexStr) => {
            return this.amountkey[assetHexStr];
        };
        this.assetExists = (assetHexStr) => {
            return assetHexStr in this.amountkey;
        };
        this.getInputs = () => {
            return this.inputs;
        };
        this.getOutputs = () => {
            return this.outputs;
        };
        this.getChangeOutputs = () => {
            return this.change;
        };
        this.getAllOutputs = () => {
            return this.outputs.concat(this.change);
        };
        this.canComplete = () => {
            for (let i = 0; i < this.amounts.length; i++) {
                if (!this.amounts[i].isFinished()) {
                    return false;
                }
            }
            return true;
        };
        this.destinations = destinations;
        this.changeAddresses = changeAddresses;
        this.senders = senders;
    }
}
exports.StandardAssetAmountDestination = StandardAssetAmountDestination;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXRhbW91bnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29tbW9uL2Fzc2V0YW1vdW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7Ozs7OztBQUVILG9DQUFnQztBQUNoQyxrREFBc0I7QUFHdEIsNENBQXdEO0FBRXhEOztHQUVHO0FBQ0gsTUFBYSxXQUFXO0lBcUZ0QixZQUFZLE9BQWUsRUFBRSxNQUFVLEVBQUUsSUFBUTtRQXBGakQsc0NBQXNDO1FBQzVCLFlBQU8sR0FBVyxlQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFBO1FBQzVDLDRDQUE0QztRQUNsQyxXQUFNLEdBQU8sSUFBSSxlQUFFLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDaEMsMERBQTBEO1FBQ2hELFNBQUksR0FBTyxJQUFJLGVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUU5QixrRUFBa0U7UUFDeEQsVUFBSyxHQUFPLElBQUksZUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQy9CLDZFQUE2RTtRQUM3RSxjQUFjO1FBQ0osdUJBQWtCLEdBQU8sSUFBSSxlQUFFLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFFNUMsOEVBQThFO1FBQzlFLDJDQUEyQztRQUNqQyxXQUFNLEdBQU8sSUFBSSxlQUFFLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDaEMsd0VBQXdFO1FBQ3hFLHFCQUFxQjtRQUNYLHdCQUFtQixHQUFZLEtBQUssQ0FBQTtRQUU5QyxtRUFBbUU7UUFDekQsYUFBUSxHQUFZLEtBQUssQ0FBQTtRQUVuQyxlQUFVLEdBQUcsR0FBVyxFQUFFO1lBQ3hCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQTtRQUNyQixDQUFDLENBQUE7UUFFRCxxQkFBZ0IsR0FBRyxHQUFXLEVBQUU7WUFDOUIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUNyQyxDQUFDLENBQUE7UUFFRCxj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QUFJLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQTtRQUNoQyxJQUFJLENBQUMsZUFBZSxHQUFHLGVBQWUsQ0FBQTtRQUN0QyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQTtJQUN4QixDQUFDO0NBQ0Y7QUEzRkQsd0VBMkZDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAcGFja2FnZURvY3VtZW50YXRpb25cbiAqIEBtb2R1bGUgQ29tbW9uLUFzc2V0QW1vdW50XG4gKi9cblxuaW1wb3J0IHsgQnVmZmVyIH0gZnJvbSBcImJ1ZmZlci9cIlxuaW1wb3J0IEJOIGZyb20gXCJibi5qc1wiXG5pbXBvcnQgeyBTdGFuZGFyZFRyYW5zZmVyYWJsZU91dHB1dCB9IGZyb20gXCIuL291dHB1dFwiXG5pbXBvcnQgeyBTdGFuZGFyZFRyYW5zZmVyYWJsZUlucHV0IH0gZnJvbSBcIi4vaW5wdXRcIlxuaW1wb3J0IHsgSW5zdWZmaWNpZW50RnVuZHNFcnJvciB9IGZyb20gXCIuLi91dGlscy9lcnJvcnNcIlxuXG4vKipcbiAqIENsYXNzIGZvciBtYW5hZ2luZyBhc3NldCBhbW91bnRzIGluIHRoZSBVVFhPU2V0IGZlZSBjYWxjdWF0aW9uXG4gKi9cbmV4cG9ydCBjbGFzcyBBc3NldEFtb3VudCB7XG4gIC8vIGFzc2V0SUQgdGhhdCBpcyBhbW91bnQgaXMgbWFuYWdpbmcuXG4gIHByb3RlY3RlZCBhc3NldElEOiBCdWZmZXIgPSBCdWZmZXIuYWxsb2MoMzIpXG4gIC8vIGFtb3VudCBvZiB0aGlzIGFzc2V0IHRoYXQgc2hvdWxkIGJlIHNlbnQuXG4gIHByb3RlY3RlZCBhbW91bnQ6IEJOID0gbmV3IEJOKDApXG4gIC8vIGJ1cm4gaXMgdGhlIGFtb3VudCBvZiB0aGlzIGFzc2V0IHRoYXQgc2hvdWxkIGJlIGJ1cm5lZC5cbiAgcHJvdGVjdGVkIGJ1cm46IEJOID0gbmV3IEJOKDApXG5cbiAgLy8gc3BlbnQgaXMgdGhlIHRvdGFsIGFtb3VudCBvZiB0aGlzIGFzc2V0IHRoYXQgaGFzIGJlZW4gY29uc3VtZWQuXG4gIHByb3RlY3RlZCBzcGVudDogQk4gPSBuZXcgQk4oMClcbiAgLy8gc3Rha2VhYmxlTG9ja1NwZW50IGlzIHRoZSBhbW91bnQgb2YgdGhpcyBhc3NldCB0aGF0IGhhcyBiZWVuIGNvbnN1bWVkIHRoYXRcbiAgLy8gd2FzIGxvY2tlZC5cbiAgcHJvdGVjdGVkIHN0YWtlYWJsZUxvY2tTcGVudDogQk4gPSBuZXcgQk4oMClcblxuICAvLyBjaGFuZ2UgaXMgdGhlIGV4Y2VzcyBhbW91bnQgb2YgdGhpcyBhc3NldCB0aGF0IHdhcyBjb25zdW1lZCBvdmVyIHRoZSBhbW91bnRcbiAgLy8gcmVxdWVzdGVkIHRvIGJlIGNvbnN1bWVkKGFtb3VudCArIGJ1cm4pLlxuICBwcm90ZWN0ZWQgY2hhbmdlOiBCTiA9IG5ldyBCTigwKVxuICAvLyBzdGFrZWFibGVMb2NrQ2hhbmdlIGlzIGEgZmxhZyB0byBtYXJrIGlmIHRoZSBpbnB1dCB0aGF0IGdlbmVyYXRlZCB0aGVcbiAgLy8gY2hhbmdlIHdhcyBsb2NrZWQuXG4gIHByb3RlY3RlZCBzdGFrZWFibGVMb2NrQ2hhbmdlOiBib29sZWFuID0gZmFsc2VcblxuICAvLyBmaW5pc2hlZCBpcyBhIGNvbnZlbmllbmNlIGZsYWcgdG8gdHJhY2sgXCJzcGVudCA+PSBhbW91bnQgKyBidXJuXCJcbiAgcHJvdGVjdGVkIGZpbmlzaGVkOiBib29sZWFuID0gZmFsc2VcblxuICBnZXRBc3NldElEID0gKCk6IEJ1ZmZlciA9PiB7XG4gICAgcmV0dXJuIHRoaXMuYXNzZXRJRFxuICB9XG5cbiAgZ2V0QXNzZXRJRFN0cmluZyA9ICgpOiBzdHJpbmcgPT4ge1xuICAgIHJldHVybiB0aGlzLmFzc2V0SUQudG9TdHJpbmcoXCJoZXhcIilcbiAgfVxuXG4gIGdldEFtb3VudCA9ICgpOiBCTiA9PiB7XG4gICAgcmV0dXJuIHRoaXMuYW1vdW50XG4gIH1cblxuICBnZXRTcGVudCA9ICgpOiBCTiA9PiB7XG4gICAgcmV0dXJuIHRoaXMuc3BlbnRcbiAgfVxuXG4gIGdldEJ1cm4gPSAoKTogQk4gPT4ge1xuICAgIHJldHVybiB0aGlzLmJ1cm5cbiAgfVxuXG4gIGdldENoYW5nZSA9ICgpOiBCTiA9PiB7XG4gICAgcmV0dXJuIHRoaXMuY2hhbmdlXG4gIH1cblxuICBnZXRTdGFrZWFibGVMb2NrU3BlbnQgPSAoKTogQk4gPT4ge1xuICAgIHJldHVybiB0aGlzLnN0YWtlYWJsZUxvY2tTcGVudFxuICB9XG5cbiAgZ2V0U3Rha2VhYmxlTG9ja0NoYW5nZSA9ICgpOiBib29sZWFuID0+IHtcbiAgICByZXR1cm4gdGhpcy5zdGFrZWFibGVMb2NrQ2hhbmdlXG4gIH1cblxuICBpc0ZpbmlzaGVkID0gKCk6IGJvb2xlYW4gPT4ge1xuICAgIHJldHVybiB0aGlzLmZpbmlzaGVkXG4gIH1cblxuICAvLyBzcGVuZEFtb3VudCBzaG91bGQgb25seSBiZSBjYWxsZWQgaWYgdGhpcyBhc3NldCBpcyBzdGlsbCBhd2FpdGluZyBtb3JlXG4gIC8vIGZ1bmRzIHRvIGNvbnN1bWUuXG4gIHNwZW5kQW1vdW50ID0gKGFtdDogQk4sIHN0YWtlYWJsZUxvY2tlZDogYm9vbGVhbiA9IGZhbHNlKTogYm9vbGVhbiA9PiB7XG4gICAgaWYgKHRoaXMuZmluaXNoZWQpIHtcbiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovXG4gICAgICB0aHJvdyBuZXcgSW5zdWZmaWNpZW50RnVuZHNFcnJvcihcbiAgICAgICAgXCJFcnJvciAtIEFzc2V0QW1vdW50LnNwZW5kQW1vdW50OiBhdHRlbXB0ZWQgdG8gc3BlbmQgXCIgKyBcImV4Y2VzcyBmdW5kc1wiXG4gICAgICApXG4gICAgfVxuICAgIHRoaXMuc3BlbnQgPSB0aGlzLnNwZW50LmFkZChhbXQpXG4gICAgaWYgKHN0YWtlYWJsZUxvY2tlZCkge1xuICAgICAgdGhpcy5zdGFrZWFibGVMb2NrU3BlbnQgPSB0aGlzLnN0YWtlYWJsZUxvY2tTcGVudC5hZGQoYW10KVxuICAgIH1cblxuICAgIGNvbnN0IHRvdGFsOiBCTiA9IHRoaXMuYW1vdW50LmFkZCh0aGlzLmJ1cm4pXG4gICAgaWYgKHRoaXMuc3BlbnQuZ3RlKHRvdGFsKSkge1xuICAgICAgdGhpcy5jaGFuZ2UgPSB0aGlzLnNwZW50LnN1Yih0b3RhbClcbiAgICAgIGlmIChzdGFrZWFibGVMb2NrZWQpIHtcbiAgICAgICAgdGhpcy5zdGFrZWFibGVMb2NrQ2hhbmdlID0gdHJ1ZVxuICAgICAgfVxuICAgICAgdGhpcy5maW5pc2hlZCA9IHRydWVcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuZmluaXNoZWRcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKGFzc2V0SUQ6IEJ1ZmZlciwgYW1vdW50OiBCTiwgYnVybjogQk4pIHtcbiAgICB0aGlzLmFzc2V0SUQgPSBhc3NldElEXG4gICAgdGhpcy5hbW91bnQgPSB0eXBlb2YgYW1vdW50ID09PSBcInVuZGVmaW5lZFwiID8gbmV3IEJOKDApIDogYW1vdW50XG4gICAgdGhpcy5idXJuID0gdHlwZW9mIGJ1cm4gPT09IFwidW5kZWZpbmVkXCIgPyBuZXcgQk4oMCkgOiBidXJuXG4gICAgdGhpcy5zcGVudCA9IG5ldyBCTigwKVxuICAgIHRoaXMuc3Rha2VhYmxlTG9ja1NwZW50ID0gbmV3IEJOKDApXG4gICAgdGhpcy5zdGFrZWFibGVMb2NrQ2hhbmdlID0gZmFsc2VcbiAgfVxufVxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgU3RhbmRhcmRBc3NldEFtb3VudERlc3RpbmF0aW9uPFxuICBUTyBleHRlbmRzIFN0YW5kYXJkVHJhbnNmZXJhYmxlT3V0cHV0LFxuICBUSSBleHRlbmRzIFN0YW5kYXJkVHJhbnNmZXJhYmxlSW5wdXRcbj4ge1xuICBwcm90ZWN0ZWQgYW1vdW50czogQXNzZXRBbW91bnRbXSA9IFtdXG4gIHByb3RlY3RlZCBkZXN0aW5hdGlvbnM6IEJ1ZmZlcltdID0gW11cbiAgcHJvdGVjdGVkIHNlbmRlcnM6IEJ1ZmZlcltdID0gW11cbiAgcHJvdGVjdGVkIGNoYW5nZUFkZHJlc3NlczogQnVmZmVyW10gPSBbXVxuICBwcm90ZWN0ZWQgYW1vdW50a2V5OiBvYmplY3QgPSB7fVxuICBwcm90ZWN0ZWQgaW5wdXRzOiBUSVtdID0gW11cbiAgcHJvdGVjdGVkIG91dHB1dHM6IFRPW10gPSBbXVxuICBwcm90ZWN0ZWQgY2hhbmdlOiBUT1tdID0gW11cblxuICAvLyBUT0RPOiBzaG91bGQgdGhpcyBmdW5jdGlvbiBhbGxvdyBmb3IgcmVwZWF0ZWQgY2FsbHMgd2l0aCB0aGUgc2FtZVxuICAvLyAgICAgICBhc3NldElEP1xuICBhZGRBc3NldEFtb3VudCA9IChhc3NldElEOiBCdWZmZXIsIGFtb3VudDogQk4sIGJ1cm46IEJOKSA9PiB7XG4gICAgbGV0IGFhOiBBc3NldEFtb3VudCA9IG5ldyBBc3NldEFtb3VudChhc3NldElELCBhbW91bnQsIGJ1cm4pXG4gICAgdGhpcy5hbW91bnRzLnB1c2goYWEpXG4gICAgdGhpcy5hbW91bnRrZXlbYWEuZ2V0QXNzZXRJRFN0cmluZygpXSA9IGFhXG4gIH1cblxuICBhZGRJbnB1dCA9IChpbnB1dDogVEkpID0+IHtcbiAgICB0aGlzLmlucHV0cy5wdXNoKGlucHV0KVxuICB9XG5cbiAgYWRkT3V0cHV0ID0gKG91dHB1dDogVE8pID0+IHtcbiAgICB0aGlzLm91dHB1dHMucHVzaChvdXRwdXQpXG4gIH1cblxuICBhZGRDaGFuZ2UgPSAob3V0cHV0OiBUTykgPT4ge1xuICAgIHRoaXMuY2hhbmdlLnB1c2gob3V0cHV0KVxuICB9XG5cbiAgZ2V0QW1vdW50cyA9ICgpOiBBc3NldEFtb3VudFtdID0+IHtcbiAgICByZXR1cm4gdGhpcy5hbW91bnRzXG4gIH1cblxuICBnZXREZXN0aW5hdGlvbnMgPSAoKTogQnVmZmVyW10gPT4ge1xuICAgIHJldHVybiB0aGlzLmRlc3RpbmF0aW9uc1xuICB9XG5cbiAgZ2V0U2VuZGVycyA9ICgpOiBCdWZmZXJbXSA9PiB7XG4gICAgcmV0dXJuIHRoaXMuc2VuZGVyc1xuICB9XG5cbiAgZ2V0Q2hhbmdlQWRkcmVzc2VzID0gKCk6IEJ1ZmZlcltdID0+IHtcbiAgICByZXR1cm4gdGhpcy5jaGFuZ2VBZGRyZXNzZXNcbiAgfVxuXG4gIGdldEFzc2V0QW1vdW50ID0gKGFzc2V0SGV4U3RyOiBzdHJpbmcpOiBBc3NldEFtb3VudCA9PiB7XG4gICAgcmV0dXJuIHRoaXMuYW1vdW50a2V5W2Fzc2V0SGV4U3RyXVxuICB9XG5cbiAgYXNzZXRFeGlzdHMgPSAoYXNzZXRIZXhTdHI6IHN0cmluZyk6IGJvb2xlYW4gPT4ge1xuICAgIHJldHVybiBhc3NldEhleFN0ciBpbiB0aGlzLmFtb3VudGtleVxuICB9XG5cbiAgZ2V0SW5wdXRzID0gKCk6IFRJW10gPT4ge1xuICAgIHJldHVybiB0aGlzLmlucHV0c1xuICB9XG5cbiAgZ2V0T3V0cHV0cyA9ICgpOiBUT1tdID0+IHtcbiAgICByZXR1cm4gdGhpcy5vdXRwdXRzXG4gIH1cblxuICBnZXRDaGFuZ2VPdXRwdXRzID0gKCk6IFRPW10gPT4ge1xuICAgIHJldHVybiB0aGlzLmNoYW5nZVxuICB9XG5cbiAgZ2V0QWxsT3V0cHV0cyA9ICgpOiBUT1tdID0+IHtcbiAgICByZXR1cm4gdGhpcy5vdXRwdXRzLmNvbmNhdCh0aGlzLmNoYW5nZSlcbiAgfVxuXG4gIGNhbkNvbXBsZXRlID0gKCk6IGJvb2xlYW4gPT4ge1xuICAgIGZvciAobGV0IGk6IG51bWJlciA9IDA7IGkgPCB0aGlzLmFtb3VudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmICghdGhpcy5hbW91bnRzW2ldLmlzRmluaXNoZWQoKSkge1xuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWVcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGRlc3RpbmF0aW9uczogQnVmZmVyW10sXG4gICAgc2VuZGVyczogQnVmZmVyW10sXG4gICAgY2hhbmdlQWRkcmVzc2VzOiBCdWZmZXJbXVxuICApIHtcbiAgICB0aGlzLmRlc3RpbmF0aW9ucyA9IGRlc3RpbmF0aW9uc1xuICAgIHRoaXMuY2hhbmdlQWRkcmVzc2VzID0gY2hhbmdlQWRkcmVzc2VzXG4gICAgdGhpcy5zZW5kZXJzID0gc2VuZGVyc1xuICB9XG59XG4iXX0=