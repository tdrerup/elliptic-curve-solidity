{"version":3,"file":"index.js","sourceRoot":"","sources":["../../src/index.ts"],"names":[],"mappings":";;;AAAA,uDAA+C;AAC/C,8CAA4D;AAC5D,4DAA4D;AAQ5D,MAAa,cAAc;IAGzB;;;OAGG;IACH,YAAmB,UAA4B,IAAI,iBAAO,EAAE,EAAE,KAAK,GAAG,KAAK;QAAxD,YAAO,GAAP,OAAO,CAAkC;QAC1D,MAAM,SAAS,GAAG,mCAAkB,EAAE,CAAA,CAAC,8BAA8B;QACrE,IAAI,CAAC,WAAW,GAAG,OAAO,CAAC,IAAI,CAAA;QAC/B,IAAI,CAAC,UAAU,GAAG;YAChB,SAAS;YACT,KAAK;SACN,CAAA;QACD,gDAAgD;QAChD,eAAI,CAAC,mBAAmB,CAAC,SAAS,CAAC,CAAA;IACrC,CAAC;IAEM,KAAK,CAIV,gBAAmB,EAAE,GAAM,EAAE,GAAsB;QACnD,OAAO,IAAI,OAAO,CAAI,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE;YACxC,MAAM,QAAQ,GAAG,GAAG,CAAC,CAAC,mBAAM,GAAG,CAAC,MAAM,EAAE,EAAG,CAAC,mBAAM,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE,CAAE,CAAA;YACzE,eAAI,CAAC,KAAK,CAAC,gBAAgB,EAAE;gBAC3B,OAAO,EAAE,GAAG;gBACZ,IAAI,EAAE,IAAI,CAAC,WAAW;gBACtB,SAAS,EAAE,IAAI,CAAC,UAAU,CAAC,SAAS;gBACpC,KAAK,EAAE,IAAI,CAAC,UAAU,CAAC,KAAK;gBAC5B,QAAQ;gBACR,KAAK,EAAE,CAAC,GAAwB,EAAE,EAAE;oBAClC,MAAM,EAAE,MAAM,EAAE,aAAa,EAAE,OAAO,EAAE,GAAG,GAAG,CAAA;oBAC9C,IAAI,MAAM,KAAK,eAAI,CAAC,IAAI,CAAC,EAAE,EAAE;wBAC3B,OAAO,CAAC,OAAc,CAAC,CAAA;qBACxB;yBAAM;wBACL,MAAM,GAAG,GAAiB;4BACxB,OAAO,EAAE,aAAa;4BACtB,IAAI,EAAE,MAAM;4BACZ,QAAQ;yBACT,CAAA;wBACD,MAAM,CAAC,GAAG,CAAC,CAAA;qBACZ;gBACH,CAAC;aACF,CAAC,CAAA;QACJ,CAAC,CAAC,CAAA;IACJ,CAAC;CACF;AA/CD,wCA+CC","sourcesContent":["import { grpc } from '@improbable-eng/grpc-web'\nimport { Context, ContextInterface } from '@textile/context'\nimport { WebsocketTransport } from '@textile/grpc-transport'\n\nexport interface ServiceError {\n  message: string\n  code: number\n  metadata: grpc.Metadata\n}\n\nexport class GrpcConnection {\n  public serviceHost: string\n  public rpcOptions: grpc.RpcOptions\n  /**\n   * Creates a new gRPC client instance for accessing the Textile Buckets API.\n   * @param context The context to use for interacting with the APIs. Can be modified later.\n   */\n  constructor(public context: ContextInterface = new Context(), debug = false) {\n    const transport = WebsocketTransport() // Default to websocket always\n    this.serviceHost = context.host\n    this.rpcOptions = {\n      transport,\n      debug,\n    }\n    // Set default transport to websocket \"globally\"\n    grpc.setDefaultTransport(transport)\n  }\n\n  public unary<\n    R extends grpc.ProtobufMessage,\n    T extends grpc.ProtobufMessage,\n    M extends grpc.UnaryMethodDefinition<R, T>\n  >(methodDescriptor: M, req: R, ctx?: ContextInterface): Promise<T> {\n    return new Promise<T>((resolve, reject) => {\n      const metadata = ctx ? { ...ctx.toJSON() } : { ...this.context.toJSON() }\n      grpc.unary(methodDescriptor, {\n        request: req,\n        host: this.serviceHost,\n        transport: this.rpcOptions.transport,\n        debug: this.rpcOptions.debug,\n        metadata,\n        onEnd: (res: grpc.UnaryOutput<T>) => {\n          const { status, statusMessage, message } = res\n          if (status === grpc.Code.OK) {\n            resolve(message as any)\n          } else {\n            const err: ServiceError = {\n              message: statusMessage,\n              code: status,\n              metadata,\n            }\n            reject(err)\n          }\n        },\n      })\n    })\n  }\n}\n"]}